<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Loop | é‡è¦æ—¥å­</title>
    <link rel="icon" href="./touxiang.jpg">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        kaggle: {
                            bg: '#F5F5F5',         // æµ…ç°èƒŒæ™¯
                            darkBg: '#0e1117',     // æ·±è‰²èƒŒæ™¯
                            primary: '#20BEFF',    // Kaggle é’è‰²
                            card: '#FFFFFF',
                            cardDark: '#161b22',   // GitHub/Kaggle æ·±è‰²å¡ç‰‡
                            text: '#37475A',
                            textDark: '#E6E6E6'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        [v-cloak] { display: none; }
        body { transition: background-color 0.3s, color 0.3s; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>

<body :class="theme" class="antialiased min-h-screen bg-kaggle-bg dark:bg-kaggle-darkBg text-kaggle-text dark:text-kaggle-textDark selection:bg-kaggle-primary selection:text-white">

<div id="app" v-cloak class="max-w-4xl mx-auto px-4 py-8">

    <header class="flex justify-between items-center mb-10">
        <div class="flex items-center gap-3 cursor-pointer" @click="goHome">
            <img src="./touxiang.jpg" class="w-10 h-10 rounded-full border-2 border-kaggle-primary shadow-sm" alt="Logo">
            <h1 class="text-2xl font-bold tracking-tight hover:text-kaggle-primary transition">Memory Loop</h1>
        </div>
        
        <div class="flex gap-3">
            <button @click="toggleLang" class="text-xs font-bold px-3 py-1.5 rounded-full border border-gray-300 dark:border-gray-700 hover:border-kaggle-primary transition">
                {{ lang === 'zh' ? 'EN' : 'ä¸­' }}
            </button>
            <button @click="toggleTheme" class="p-1.5 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 transition">
                {{ theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™' }}
            </button>
        </div>
    </header>

    <transition name="fade">
        <div v-if="alertMsg" class="mb-8 p-4 rounded-xl bg-gradient-to-r from-amber-50 to-orange-50 dark:from-amber-900/30 dark:to-orange-900/30 border border-amber-200 dark:border-amber-700 flex items-center gap-3 shadow-sm">
            <span class="text-2xl">ğŸ””</span>
            <div>
                <h3 class="font-bold text-amber-800 dark:text-amber-200">{{ t('reminder_title') }}</h3>
                <p class="text-sm text-amber-700 dark:text-amber-300">{{ alertMsg }}</p>
            </div>
        </div>
    </transition>

    <div class="flex justify-between items-end mb-6">
        <div>
            <h2 class="text-3xl font-bold">{{ t('dashboard_title') }}</h2>
            <p class="text-gray-500 dark:text-gray-400 text-sm mt-1">{{ events.length }} {{ t('events_count') }}</p>
        </div>
        <button @click="showModal = true" class="bg-kaggle-primary hover:brightness-110 text-white font-semibold py-2 px-5 rounded-full shadow-lg shadow-blue-500/30 transition transform active:scale-95 flex items-center gap-2">
            <span>+</span> {{ t('add_btn') }}
        </button>
    </div>

    <div v-if="sortedEvents.length > 0" class="grid gap-4 md:grid-cols-2">
        <div v-for="item in sortedEvents" :key="item.id" 
             class="group relative p-5 rounded-2xl border transition-all duration-300 hover:-translate-y-1 hover:shadow-md bg-kaggle-card dark:bg-kaggle-cardDark dark:border-gray-700"
             :class="item.daysLeft === 0 ? 'border-kaggle-primary ring-1 ring-kaggle-primary' : 'border-gray-200'">
            
            <div class="flex justify-between items-start">
                <div>
                    <div class="flex items-center gap-2">
                        <h3 class="font-bold text-lg">{{ item.name }}</h3>
                        <span class="text-[10px] px-2 py-0.5 rounded bg-gray-100 dark:bg-gray-800 text-gray-500 uppercase tracking-wider">{{ item.type }}</span>
                    </div>
                    <p class="text-sm text-gray-400 mt-1 font-mono">{{ item.date }}</p>
                </div>
                <div class="text-right">
                    <div class="text-3xl font-bold tracking-tighter" :class="item.daysLeft === 0 ? 'text-kaggle-primary' : ''">
                        <span v-if="item.daysLeft === 0">TODAY!</span>
                        <span v-else>{{ item.daysLeft }}<span class="text-sm font-normal text-gray-400 ml-1">d</span></span>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">{{ t('turns') }} {{ getAge(item.date) }}</p>
                </div>
            </div>

            <button @click="deleteEvent(item.id)" class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 text-gray-300 hover:text-red-500 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
    </div>

    <div v-else class="text-center py-20 border-2 border-dashed border-gray-200 dark:border-gray-800 rounded-2xl">
        <div class="text-4xl mb-3">ğŸƒ</div>
        <p class="text-gray-500">{{ t('empty_state') }}</p>
    </div>

    <footer class="mt-12 text-center text-xs text-gray-400 border-t border-gray-200 dark:border-gray-800 pt-6">
        <p>&copy; 2025 Dianfu Zhou. Built for memories.</p>
        <a href="/" class="hover:text-kaggle-primary mt-2 inline-block underline decoration-dashed">{{ t('back_home') }}</a>
    </footer>

    <div v-if="showModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4" @click.self="showModal = false">
        <div class="bg-white dark:bg-kaggle-cardDark w-full max-w-md rounded-2xl shadow-2xl p-6 transform transition-all scale-100">
            <h3 class="text-xl font-bold mb-4">{{ t('modal_title') }}</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">{{ t('label_name') }}</label>
                    <input v-model="newItem.name" type="text" class="w-full bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 focus:outline-none focus:border-kaggle-primary focus:ring-1 focus:ring-kaggle-primary transition">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">{{ t('label_date') }}</label>
                    <input v-model="newItem.date" type="date" class="w-full bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 focus:outline-none focus:border-kaggle-primary">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">{{ t('label_tag') }}</label>
                    <div class="flex gap-2">
                        <span v-for="tag in ['Birthday', 'Anniversary', 'Holiday']" :key="tag" 
                              @click="newItem.type = tag"
                              class="cursor-pointer px-3 py-1 rounded-md text-xs border transition"
                              :class="newItem.type === tag ? 'bg-kaggle-primary text-white border-kaggle-primary' : 'border-gray-200 dark:border-gray-700 text-gray-500'">
                            {{ tag }}
                        </span>
                    </div>
                </div>
            </div>

            <div class="mt-6 flex justify-end gap-2">
                <button @click="showModal = false" class="px-4 py-2 rounded-lg text-sm font-medium text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800">{{ t('cancel') }}</button>
                <button @click="addEvent" :disabled="!newItem.name || !newItem.date" class="px-4 py-2 rounded-lg text-sm font-bold bg-kaggle-primary text-white hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed">{{ t('save') }}</button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted, watch } = Vue;

    createApp({
        setup() {
            // æ•°æ®ä¸çŠ¶æ€
            const events = ref([]);
            const lang = ref(localStorage.getItem('ml_lang') || 'zh');
            const theme = ref(localStorage.getItem('ml_theme') || 'light');
            const showModal = ref(false);
            const alertMsg = ref('');
            const newItem = ref({ name: '', date: '', type: 'Birthday' });

            // å­—å…¸
            const i18n = {
                zh: {
                    dashboard_title: 'å³å°†åˆ°æ¥',
                    events_count: 'ä¸ªè®°å½•',
                    add_btn: 'æ·»åŠ ',
                    reminder_title: 'æ¸©é¦¨æé†’',
                    turns: 'å³å°†',
                    empty_state: 'è¿˜æ²¡æœ‰è®°å½•ï¼Œç‚¹å‡»å³ä¸Šè§’æ·»åŠ ã€‚',
                    back_home: 'è¿”å›ä¸»é¡µ',
                    modal_title: 'æ·»åŠ æ–°æ—¥å­',
                    label_name: 'åç§° (è°çš„ç”Ÿæ—¥?)',
                    label_date: 'æ—¥æœŸ (å¹´ä»½ä¸é‡è¦ï¼Œä¼šè‡ªåŠ¨è®¡ç®—)',
                    label_tag: 'ç±»å‹',
                    cancel: 'å–æ¶ˆ',
                    save: 'ä¿å­˜',
                    alert_tomorrow: 'æ˜å¤©æ˜¯ {name} çš„æ—¥å­ï¼Œåˆ«å¿˜äº†å‡†å¤‡ï¼',
                    alert_today: 'ä»Šå¤©æ˜¯ {name} çš„æ—¥å­ï¼ç¥è´ºä»–/å¥¹ï¼'
                },
                en: {
                    dashboard_title: 'Upcoming',
                    events_count: 'events saved',
                    add_btn: 'Add New',
                    reminder_title: 'Reminder',
                    turns: 'Turns',
                    empty_state: 'No events yet. Add one to start.',
                    back_home: 'Back to Home',
                    modal_title: 'Add Event',
                    label_name: 'Name',
                    label_date: 'Date',
                    label_tag: 'Tag',
                    cancel: 'Cancel',
                    save: 'Save',
                    alert_tomorrow: 'Tomorrow is {name}\'s day!',
                    alert_today: 'Today is {name}\'s day! Wish them well!'
                }
            };

            const t = (key) => i18n[lang.value][key];

            // æ ¸å¿ƒç®—æ³•ï¼šè®¡ç®—å€’æ•°æ—¥
            const getDaysLeft = (dateStr) => {
                const today = new Date();
                today.setHours(0,0,0,0);
                const target = new Date(dateStr);
                // è®¾ä¸ºä»Šå¹´çš„æ—¥æœŸ
                target.setFullYear(today.getFullYear());
                
                // å¦‚æœä»Šå¹´çš„å·²ç»è¿‡äº†ï¼Œå°±è®¾ä¸ºæ˜å¹´
                if (target < today) {
                    target.setFullYear(today.getFullYear() + 1);
                }
                
                const diff = target - today;
                return Math.ceil(diff / (1000 * 60 * 60 * 24));
            };

            // è®¡ç®—å³å°†å‡ å²/å‡ å‘¨å¹´
            const getAge = (dateStr) => {
                const birthYear = new Date(dateStr).getFullYear();
                const currentYear = new Date().getFullYear();
                const isPassed = new Date(dateStr).setFullYear(currentYear) < new Date().setHours(0,0,0,0);
                return currentYear - birthYear + (isPassed ? 1 : 0);
            };

            // è®¡ç®—å±æ€§
            const sortedEvents = computed(() => {
                return events.value.map(e => ({
                    ...e,
                    daysLeft: getDaysLeft(e.date)
                })).sort((a, b) => a.daysLeft - b.daysLeft);
            });

            // æ–¹æ³•
            const addEvent = () => {
                if (!newItem.value.name || !newItem.value.date) return;
                events.value.push({ id: Date.now(), ...newItem.value });
                newItem.value = { name: '', date: '', type: 'Birthday' };
                showModal.value = false;
                saveData();
                checkAlerts(); // é‡æ–°æ£€æŸ¥æé†’
            };

            const deleteEvent = (id) => {
                if(confirm(lang.value === 'zh' ? 'åˆ é™¤æ­¤è®°å½•ï¼Ÿ' : 'Delete this event?')) {
                    events.value = events.value.filter(e => e.id !== id);
                    saveData();
                }
            };

            const saveData = () => localStorage.setItem('ml_events', JSON.stringify(events.value));
            
            const toggleTheme = () => {
                theme.value = theme.value === 'dark' ? 'light' : 'dark';
                localStorage.setItem('ml_theme', theme.value);
                applyTheme();
            };

            const applyTheme = () => {
                if (theme.value === 'dark') document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            };

            const toggleLang = () => {
                lang.value = lang.value === 'zh' ? 'en' : 'zh';
                localStorage.setItem('ml_lang', lang.value);
            };

            const goHome = () => window.location.href = '/';

            // æé†’ä¸ç‰¹æ•ˆé€»è¾‘
            const checkAlerts = () => {
                const todayItems = sortedEvents.value.filter(e => e.daysLeft === 0);
                const tmrItems = sortedEvents.value.filter(e => e.daysLeft === 1);

                if (todayItems.length > 0) {
                    // ç”Ÿæ—¥å½“å¤©ï¼šæ”¾çƒŸèŠ±
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                    // æŒç»­å‡ ç§’çš„éšæœºçƒŸèŠ±
                    const duration = 3000;
                    const end = Date.now() + duration;
                    (function frame() {
                        confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 } });
                        confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 } });
                        if (Date.now() < end) requestAnimationFrame(frame);
                    }());

                    alertMsg.value = t('alert_today').replace('{name}', todayItems.map(e=>e.name).join(', '));
                } else if (tmrItems.length > 0) {
                    // æå‰ä¸€å¤©ï¼šæ˜¾ç¤ºæé†’
                    alertMsg.value = t('alert_tomorrow').replace('{name}', tmrItems.map(e=>e.name).join(', '));
                } else {
                    alertMsg.value = '';
                }
            };

            // åˆå§‹åŒ–
            onMounted(() => {
                const saved = localStorage.getItem('ml_events');
                if (saved) events.value = JSON.parse(saved);
                applyTheme();
                checkAlerts();
            });

            return {
                events, lang, theme, showModal, newItem, alertMsg, sortedEvents,
                t, addEvent, deleteEvent, toggleTheme, toggleLang, getAge, goHome
            };
        }
    }).mount('#app');
</script>
</body>
</html>
